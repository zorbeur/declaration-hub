<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Declaration Hub API - Interactive Tester</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        header h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
        }
        
        header p {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 15px;
        }
        
        .auth-section {
            background: #f0f0f0;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .auth-section label {
            display: block;
            margin-top: 10px;
            font-weight: 600;
            color: #333;
        }
        
        .auth-section input {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }
        
        .auth-section button {
            margin-top: 15px;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        .auth-section button:hover {
            background: #764ba2;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .endpoints-list {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .endpoints-list h2 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            margin: 0;
            position: sticky;
            top: 0;
        }
        
        .endpoint-item {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .endpoint-item:hover {
            background: #f9f9f9;
        }
        
        .endpoint-item.active {
            background: #e8e8ff;
            border-left: 4px solid #667eea;
        }
        
        .method-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            margin-right: 10px;
            font-size: 0.85em;
            color: white;
        }
        
        .method-badge.GET { background: #61affe; }
        .method-badge.POST { background: #49cc90; }
        .method-badge.PUT { background: #fca130; }
        .method-badge.PATCH { background: #50e3c2; }
        .method-badge.DELETE { background: #f93e3e; }
        
        .endpoint-name {
            font-weight: 600;
            color: #333;
            margin-top: 5px;
        }
        
        .endpoint-path {
            font-family: 'Courier New', monospace;
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        .tester-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .tester-panel h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
        }
        
        .form-group textarea {
            min-height: 150px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }
        
        .send-button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-size: 1em;
        }
        
        .send-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .send-button:active {
            transform: translateY(0);
        }
        
        .response-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #eee;
        }
        
        .response-section h4 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .response-status {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }
        
        .response-status.success {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .response-status.error {
            background: #ffebee;
            color: #c62828;
        }
        
        .response-body {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .copy-button {
            padding: 8px 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 10px;
        }
        
        .copy-button:hover {
            background: #764ba2;
        }
        
        .description {
            color: #666;
            font-size: 0.95em;
            margin-top: 10px;
        }
        
        .public-badge {
            display: inline-block;
            padding: 4px 8px;
            background: #e8f5e9;
            color: #2e7d32;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .auth-badge {
            display: inline-block;
            padding: 4px 8px;
            background: #fff3e0;
            color: #e65100;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: 8px;
            margin-top: 10px;
        }
        
        .example-box {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            border-left: 4px solid #667eea;
        }
        
        .example-box h5 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .example-box pre {
            background: white;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .no-endpoint-selected {
            text-align: center;
            color: #999;
            padding: 40px;
            font-size: 1.1em;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .pagination-info {
            color: #666;
            font-size: 0.9em;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîê Declaration Hub API - Interactive Tester</h1>
            <p>Test all API endpoints with comprehensive documentation and examples</p>
            <p style="color: #999; font-size: 0.95em;">‚úì All endpoints documented ‚Ä¢ ‚úì JSON examples provided ‚Ä¢ ‚úì Real-time testing ‚Ä¢ ‚úì Full audit trail</p>
            
            <div class="auth-section">
                <label>JWT Access Token (for authenticated endpoints)</label>
                <input type="text" id="token" placeholder="Paste your JWT token here..." />
                <label style="margin-top: 15px;">Base URL</label>
                <input type="text" id="baseUrl" value="http://127.0.0.1:8000" placeholder="Base URL (e.g., http://127.0.0.1:8000)" />
                <button onclick="testConnection()">Test Connection</button>
                <button onclick="clearToken()" style="margin-left: 10px; background: #999;">Clear Token</button>
            </div>
        </header>
        
        <div class="main-content">
            <div class="endpoints-list" id="endpointsList">
                <h2>Available Endpoints</h2>
                <!-- Populated by JavaScript -->
            </div>
            
            <div class="tester-panel" id="testerPanel">
                <div class="no-endpoint-selected">
                    üëà Select an endpoint to get started
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // API Endpoints Data
        const apiEndpoints = JSON.parse('{{ endpoints|safe|escapejs }}') || [];
        
        let selectedEndpoint = null;
        let baseUrl = localStorage.getItem('apiBaseUrl') || 'http://127.0.0.1:8000';
        let token = localStorage.getItem('apiToken') || '';
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('baseUrl').value = baseUrl;
            document.getElementById('token').value = token;
            renderEndpoints();
        });
        
        // Store token and baseUrl
        document.getElementById('token').addEventListener('change', function() {
            token = this.value;
            localStorage.setItem('apiToken', token);
        });
        
        document.getElementById('baseUrl').addEventListener('change', function() {
            baseUrl = this.value;
            localStorage.setItem('apiBaseUrl', baseUrl);
        });
        
        function clearToken() {
            token = '';
            localStorage.removeItem('apiToken');
            document.getElementById('token').value = '';
        }
        
        function testConnection() {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>Testing...';
            
            fetch(baseUrl + '/api/').then(r => {
                if (r.ok) {
                    alert('‚úì Connection successful!');
                } else {
                    alert('‚úó Connection failed: ' + r.status);
                }
            }).catch(e => {
                alert('‚úó Error: ' + e.message);
            }).finally(() => {
                btn.disabled = false;
                btn.innerHTML = 'Test Connection';
            });
        }
        
        function renderEndpoints() {
            const list = document.getElementById('endpointsList');
            let html = '<h2>Available Endpoints (' + apiEndpoints.length + ')</h2>';
            
            apiEndpoints.forEach((ep, idx) => {
                const auth = ep.auth_required ? '<span class="auth-badge">Requires Auth</span>' : '<span class="public-badge">Public</span>';
                html += `
                    <div class="endpoint-item" onclick="selectEndpoint(${idx})">
                        <span class="method-badge ${ep.method}">${ep.method}</span>
                        <span class="endpoint-name">${ep.name}</span>
                        ${auth}
                        <div class="endpoint-path">${ep.endpoint}</div>
                    </div>
                `;
            });
            
            list.innerHTML = html;
        }
        
        function selectEndpoint(idx) {
            selectedEndpoint = apiEndpoints[idx];
            
            // Update active state
            document.querySelectorAll('.endpoint-item').forEach((el, i) => {
                el.classList.toggle('active', i === idx);
            });
            
            renderTesterPanel();
        }
        
        function renderTesterPanel() {
            const ep = selectedEndpoint;
            const tester = document.getElementById('testerPanel');
            
            let html = `
                <h3>${ep.name}</h3>
                <div class="description">${ep.description}</div>
            `;
            
            if (ep.auth_required) {
                html += '<span class="auth-badge" style="margin-top: 10px;">Requires Authentication</span>';
                if (ep.admin_required) {
                    html += '<span class="auth-badge" style="margin-left: 10px;">Admin Required</span>';
                }
            } else {
                html += '<span class="public-badge" style="margin-top: 10px;">Public Endpoint</span>';
            }
            
            // Endpoint path
            html += `<div class="example-box"><h5>Endpoint Path</h5><pre>${ep.endpoint}</pre></div>`;
            
            // Request example
            if (ep.example && (ep.method === 'POST' || ep.method === 'PUT' || ep.method === 'PATCH')) {
                html += `
                    <div class="example-box" style="margin-top: 15px;">
                        <h5>Request Example (JSON)</h5>
                        <pre>${JSON.stringify(ep.example, null, 2)}</pre>
                        <button class="copy-button" onclick="copyToClipboard(this, '${JSON.stringify(ep.example, null, 2).replace(/'/g, "\\'")}')">Copy</button>
                    </div>
                `;
            }
            
            // Request form
            if (ep.method !== 'GET' && ep.method !== 'DELETE' && ep.request_body) {
                html += '<div class="form-group"><label>Request Body (JSON)</label>';
                html += '<textarea id="requestBody" placeholder=\'{"key": "value"}\'>';
                if (ep.example) {
                    html += JSON.stringify(ep.example, null, 2);
                }
                html += '</textarea></div>';
            }
            
            // Parameters
            if (ep.params) {
                html += '<div class="form-group"><label>Query Parameters</label>';
                for (const [key, val] of Object.entries(ep.params)) {
                    html += `<input type="text" placeholder="${key}: ${val}" class="param" data-param="${key}" />`;
                }
                html += '</div>';
            }
            
            // Send button
            html += `<button class="send-button" onclick="sendRequest()">Send ${ep.method} Request</button>`;
            
            // Response section
            html += '<div class="response-section"><h4>Response</h4><div id="responseArea"></div></div>';
            
            tester.innerHTML = html;
        }
        
        function copyToClipboard(btn, text) {
            navigator.clipboard.writeText(text);
            const original = btn.innerHTML;
            btn.innerHTML = '‚úì Copied!';
            setTimeout(() => { btn.innerHTML = original; }, 2000);
        }
        
        function sendRequest() {
            const ep = selectedEndpoint;
            const responseArea = document.getElementById('responseArea');
            const btn = event.target;
            
            // Validate auth
            if (ep.auth_required && !token) {
                responseArea.innerHTML = '<div class="response-status error">‚ùå Error: Authentication token required. Paste your JWT token in the header.</div>';
                return;
            }
            
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>Sending...';
            
            // Build request
            let url = baseUrl + ep.endpoint;
            let options = {
                method: ep.method,
                headers: {
                    'Content-Type': 'application/json',
                }
            };
            
            // Add token if provided
            if (token) {
                options.headers['Authorization'] = 'Bearer ' + token;
            }
            
            // Add query params
            const params = new URLSearchParams();
            document.querySelectorAll('.param').forEach(el => {
                if (el.value) {
                    params.append(el.dataset.param, el.value);
                }
            });
            if (params.toString()) {
                url += '?' + params.toString();
            }
            
            // Add body
            if (ep.method !== 'GET' && ep.method !== 'DELETE') {
                const bodyEl = document.getElementById('requestBody');
                if (bodyEl && bodyEl.value) {
                    try {
                        options.body = JSON.stringify(JSON.parse(bodyEl.value));
                    } catch (e) {
                        responseArea.innerHTML = '<div class="response-status error">‚ùå Error: Invalid JSON in request body</div>';
                        btn.disabled = false;
                        btn.innerHTML = 'Send ' + ep.method + ' Request';
                        return;
                    }
                }
            }
            
            // Send request
            fetch(url, options)
                .then(r => {
                    const status = r.status;
                    const isSuccess = status >= 200 && status < 300;
                    return r.text().then(body => ({status, isSuccess, body}));
                })
                .then(({status, isSuccess, body}) => {
                    let html = `<div class="response-status ${isSuccess ? 'success' : 'error'}">`;
                    html += `<strong>Status Code:</strong> ${status} ${isSuccess ? '‚úì Success' : '‚úó Error'}</div>`;
                    
                    if (body) {
                        try {
                            const json = JSON.parse(body);
                            html += '<div style="margin-top: 15px;"><strong>Response Body:</strong></div>';
                            html += '<div class="response-body">' + JSON.stringify(json, null, 2) + '</div>';
                        } catch (e) {
                            html += '<div style="margin-top: 15px;"><strong>Response Body:</strong></div>';
                            html += '<div class="response-body">' + body + '</div>';
                        }
                    }
                    
                    responseArea.innerHTML = html;
                })
                .catch(e => {
                    responseArea.innerHTML = '<div class="response-status error">‚ùå Error: ' + e.message + '</div>';
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = 'Send ' + ep.method + ' Request';
                });
        }
    </script>
</body>
</html>
